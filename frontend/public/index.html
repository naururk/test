<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Proof-of-Education • Zama FHEVM</title>

  <!-- Required for Relayer SDK (WASM/Workers) -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff; --br:#e5e7eb;
      --accent:#0ea5e9; --accent-2:#10b981; --bad:#ef4444; --ok:#16a34a; --alt:#6366f1;
      --shadow:0 10px 30px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:15px/1.55 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--ink);
      background:
        radial-gradient(70% 50% at 0% 0%, rgba(16,185,129,.10), transparent 60%),
        radial-gradient(50% 40% at 100% 0%, rgba(99,102,241,.12), transparent 60%),
        var(--bg);
      padding:16px;
    }
    .wrap{
      max-width:1080px;
      margin:0 auto;
      display:grid;
      gap:14px;
      grid-template-columns: 1.1fr 1.6fr 1.1fr;
    }
    .header{
      grid-column:1/-1;
      display:flex;
      gap:12px;
      align-items:center;
      padding:14px;
      border:1px solid var(--br);
      border-radius:22px;
      background:linear-gradient(180deg,#fff,#fbfdff);
      box-shadow:var(--shadow);
    }
    .logo{
      width:42px;height:42px;border-radius:16px;
      background:conic-gradient(from 120deg,var(--accent),var(--alt),var(--accent-2),var(--accent));
      display:grid; place-items:center;
      color:#fff; font-weight:900;
      box-shadow:0 12px 34px rgba(14,165,233,.35);
    }
    .title{font-weight:900}
    .sub{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--br); background:#fff;
      color:var(--muted); font-weight:800;
    }
    .kbd{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:11px; background:#0f172a; color:#fff;
      border-radius:6px; padding:2px 6px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      min-height:40px; padding:10px 14px;
      border-radius:14px; border:1px solid var(--br);
      cursor:pointer; background:#0f172a; color:#fff;
      font-weight:900; box-shadow:0 10px 30px rgba(2,6,23,.15);
    }
    .btn.ghost{background:#fff; color:#0f172a}
    .btn.small{min-height:34px; padding:8px 12px; border-radius:12px}

    .card{
      border:1px solid var(--br);
      border-radius:22px;
      background:var(--card);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .h{
      font-size:13px; font-weight:900;
      letter-spacing:.06em; text-transform:uppercase;
      color:#0f172a;
    }
    .muted{color:var(--muted)}
    .grid{display:grid; gap:10px}
    .row{display:flex; align-items:end; gap:10px; flex-wrap:wrap}
    label{
      display:block; font-size:12px; color:#475569;
      font-weight:800; margin-bottom:6px;
    }
    .inp{
      width:100%; padding:12px;
      border:1px solid var(--br);
      border-radius:14px;
      background:#f8fafc;
      font-weight:800; color:#0f172a;
    }
    .stamp{display:grid; gap:8px}
    .ticket{
      border:1px dashed #dbe3ef;
      border-radius:18px;
      background:linear-gradient(180deg,#fff,#f6f9ff);
      padding:10px 12px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:10px;
    }
    .tag{
      font-size:11px; padding:3px 8px;
      border-radius:10px;
      border:1px solid var(--br);
      background:#f8fafc; color:#475569;
      font-weight:800;
    }
    .tag.ok{background:#ecfdf5; color:#166534; border-color:#bbf7d0}
    .tag.bad{background:#fef2f2; color:#991b1b; border-color:#fecaca}
    .note{font-size:12px; color:#0ea5e9; font-weight:800}

    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">E</div>
    <div>
      <div class="title">Proof-of-Education</div>
      <div class="sub">Encrypted modules · public tier stamps (no circles)</div>
    </div>
    <div class="spacer"></div>
    <div class="pill">
      Contract: <span id="contractShort" style="margin-left:6px" class="kbd">—</span>
    </div>
    <button id="connectBtn" class="btn">Connect Wallet</button>
  </header>

  <main class="wrap">
    <!-- LEFT: Status / Stamps -->
    <section class="card grid">
      <div class="h">Module status</div>
      <div class="grid" style="grid-template-columns:1fr auto; align-items:end; gap:10px">
        <div>
          <label>Module ID (u8)</label>
          <input id="modId" class="inp" type="number" min="0" max="255" value="1" />
        </div>
        <button id="reloadBtn" class="btn ghost small">Reload</button>
      </div>

      <div class="ticket stamp">
        <div class="row2">
          <div class="muted" style="font-size:12px">Stamp A — score ≥ T1</div>
          <code class="kbd" id="h1">—</code>
        </div>
        <div id="s1" class="tag">pending</div>

        <div class="row2">
          <div class="muted" style="font-size:12px">Stamp B — score ≥ T2</div>
          <code class="kbd" id="h2">—</code>
        </div>
        <div id="s2" class="tag">pending</div>

        <div class="row2">
          <div class="muted" style="font-size:12px">Stamp C — score ≥ T3</div>
          <code class="kbd" id="h3">—</code>
        </div>
        <div id="s3" class="tag">pending</div>

        <div class="row2" style="margin-top:6px">
          <div class="muted" style="font-size:12px">Decision</div>
          <div class="tag" id="decided">—</div>
        </div>
        <div class="row2">
          <div class="muted" style="font-size:12px">Tier</div>
          <div class="kbd" id="tier">0</div>
        </div>
        <div class="muted" style="font-size:12px">
          Raw score handle: <code class="kbd" id="scoreH">—</code>
        </div>
        <button id="privDecrypt" class="btn ghost small">
          Reveal my score (signed)
        </button>
      </div>

      <div class="muted" style="font-size:12px">
        Only the three stamps are public-decryptable on-chain. In this demo they are read via signed decrypt because of relayer CORS.
      </div>
    </section>

    <!-- CENTER: Submit -->
    <section class="card grid">
      <div class="h">Submit encrypted score</div>
      <div class="row">
        <div style="flex:1">
          <label>Score (uint16)</label>
          <input id="score" class="inp" placeholder="e.g. 87" inputmode="numeric" />
        </div>
        <button id="submitBtn" class="btn">Encrypt &amp; Submit</button>
      </div>
      <div class="ticket">
        <div class="muted" style="font-size:12px">
          <b>Flow</b>: encrypt in browser → on-chain FHE compares with encrypted thresholds → stamps become public.
        </div>
      </div>
      <div class="note" id="note"></div>
      <div class="muted" style="font-size:12px">
        If SDK fails to load, check firewall/VPN and that these CDNs are reachable:
        <code class="kbd">cdn.zama.org</code>,
        <code class="kbd">cdn.jsdelivr.net</code>,
        <code class="kbd">unpkg.com</code>.
      </div>
    </section>

    <!-- RIGHT: Admin -->
    <section class="card grid">
      <div class="h">Admin · encrypted thresholds</div>
      <div class="grid" style="grid-template-columns:repeat(3,1fr); gap:10px">
        <div><label>T1 (uint16)</label><input id="t1" class="inp" placeholder="50" /></div>
        <div><label>T2 (uint16)</label><input id="t2" class="inp" placeholder="120" /></div>
        <div><label>T3 (uint16)</label><input id="t3" class="inp" placeholder="250" /></div>
      </div>
      <button id="setThr" class="btn ghost">Encrypt &amp; Update</button>
      <div class="muted" style="font-size:12px">
        Owner: <code class="kbd" id="owner">—</code>
      </div>
    </section>
  </main>

  <!-- Logic -->
  <script type="module">
    import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
    import {
      initSDK,
      createInstance,
      SepoliaConfig,
      generateKeypair
    } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    const CONTRACT_ADDRESS = "0x0A89386172E7E5455b3a3b5f60b1797E04d8C8B0";
    const CHAIN_ID_HEX = "0xaa36a7";

    const ABI = [
      { type:"function", stateMutability:"view", name:"owner", inputs:[], outputs:[{type:"address"}] },
      {
        type:"function", stateMutability:"nonpayable", name:"setModuleThresholds",
        inputs:[
          {name:"moduleId",type:"uint8"},
          {name:"_T1",type:"bytes32"},
          {name:"_T2",type:"bytes32"},
          {name:"_T3",type:"bytes32"},
          {name:"proof",type:"bytes"},
        ], outputs:[]
      },
      {
        type:"function", stateMutability:"nonpayable", name:"submitModuleScore",
        inputs:[
          {name:"moduleId",type:"uint8"},
          {name:"encScore",type:"bytes32"},
          {name:"proof",type:"bytes"},
        ], outputs:[]
      },
      {
        type:"function", stateMutability:"view", name:"getMyModuleHandles",
        inputs:[{name:"moduleId",type:"uint8"}],
        outputs:[
          {type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bool"}
        ]
      },
      {
        type:"function", stateMutability:"view", name:"getModuleTierHandlesOf",
        inputs:[{name:"who",type:"address"},{name:"moduleId",type:"uint8"}],
        outputs:[
          {type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bool"}
        ]
      },
    ];

    const $ = (q)=>document.querySelector(q);
    $("#contractShort").textContent = short(CONTRACT_ADDRESS);

    const s1El=$("#s1"), s2El=$("#s2"), s3El=$("#s3");
    const h1El=$("#h1"), h2El=$("#h2"), h3El=$("#h3");
    const decEl=$("#decided"), tierEl=$("#tier"), scoreHEl=$("#scoreH");
    const connectBtn=$("#connectBtn"), submitBtn=$("#submitBtn"),
          reloadBtn=$("#reloadBtn"), setThrBtn=$("#setThr"),
          noteEl=$("#note"), ownerEl=$("#owner"), privBtn=$("#privDecrypt");

    function short(a){ return a ? a.slice(0,6) + "…" + a.slice(-4) : "—"; }
    function tag(el, ok){
      el.className = "tag " + (ok===true ? "ok" : ok===false ? "bad" : "");
      el.textContent = ok===true ? "cleared" : ok===false ? "locked" : "pending";
    }
    function note(msg){ noteEl.textContent = msg || ""; }

    let provider=null, signer=null, contract=null, relayer=null, me=null, owner=null;

    async function ensureSepolia(){
      const id = await window.ethereum.request({ method:"eth_chainId" });
      if (String(id).toLowerCase() === CHAIN_ID_HEX) return true;
      try {
        await window.ethereum.request({
          method:"wallet_switchEthereumChain",
          params:[{ chainId: CHAIN_ID_HEX }]
        });
      } catch (e) {
        if (e && e.code === 4902) {
          await window.ethereum.request({
            method:"wallet_addEthereumChain",
            params:[{
              chainId: CHAIN_ID_HEX,
              chainName:"Sepolia",
              nativeCurrency:{ name:"Sepolia ETH", symbol:"SEP", decimals:18 },
              rpcUrls:["https://rpc.sepolia.org"],
              blockExplorerUrls:["https://sepolia.etherscan.io"]
            }]
          });
        } else { throw e; }
      }
      const after = await window.ethereum.request({ method:"eth_chainId" });
      return String(after).toLowerCase() === CHAIN_ID_HEX;
    }

    async function connect(){
      try{
        if (!window.ethereum?.request) throw new Error("Install MetaMask");
        await window.ethereum.request({ method:"eth_requestAccounts" });
        await ensureSepolia();

        provider = new BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        me = await signer.getAddress();

        contract = new Contract(CONTRACT_ADDRESS, ABI, signer);

        await initSDK();
        relayer = await createInstance(SepoliaConfig);

        owner = await contract.owner();
        ownerEl.textContent = short(owner);

        connectBtn.textContent = "Reset";
        note("Connected");
        await refresh();
      }catch(e){
        console.error(e);
        note(e?.message || "Connect failed");
      }
    }

    async function refresh(){
      if (!contract || !relayer || !signer) return;
      const mid = Number($("#modId").value || "1");
      try{
        const r = await contract.getMyModuleHandles(mid);
        const [scoreH, p1H, p2H, p3H, decided] = r;
        const scoreHex = String(scoreH);
        const h1 = String(p1H), h2 = String(p2H), h3 = String(p3H);

        scoreHEl.textContent = short(scoreHex);
        h1El.textContent = short(h1);
        h2El.textContent = short(h2);
        h3El.textContent = short(h3);
        decEl.textContent = decided ? "computed" : "—";

        if (!decided) {
          tag(s1El,null); tag(s2El,null); tag(s3El,null);
          tierEl.textContent = "0";
          return;
        }

        // --- decrypt stamps via userDecrypt (signed) ---
        const kp = await generateKeypair();
        const startTs = Math.floor(Date.now()/1000).toString();
        const daysValid = "7";

        const eip = relayer.createEIP712(
          kp.publicKey,
          [CONTRACT_ADDRESS],
          startTs,
          daysValid
        );

        const sig = await signer.signTypedData(
          eip.domain,
          { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
          eip.message
        );

        const out = await relayer.userDecrypt(
          [
            { handle:h1, contractAddress: CONTRACT_ADDRESS },
            { handle:h2, contractAddress: CONTRACT_ADDRESS },
            { handle:h3, contractAddress: CONTRACT_ADDRESS },
          ],
          kp.privateKey,
          kp.publicKey,
          String(sig).replace(/^0x/, ""),
          [CONTRACT_ADDRESS],
          await signer.getAddress(),
          startTs,
          daysValid
        );

        const base = out || {};

        const pick = (h)=>{
          let v = base[h] ?? base[String(h).toLowerCase()];
          try{
            if (typeof v === "bigint") return v !== 0n;
            if (typeof v === "number") return v !== 0;
            if (typeof v === "string") return BigInt(v) !== 0n;
          }catch(e){}
          return false;
        };

        const b1 = pick(h1), b2 = pick(h2), b3 = pick(h3);
        tag(s1El, b1); tag(s2El, b2); tag(s3El, b3);
        tierEl.textContent = String((b1?1:0)+(b2?1:0)+(b3?1:0));
      }catch(e){
        console.error(e);
        note(e?.message || "Refresh failed");
      }
    }

    async function submit(){
      try{
        if (!relayer || !contract || !signer) throw new Error("Connect first");
        const mid = Number($("#modId").value || "1");
        const val = Number($("#score").value || "0");
        if (!Number.isInteger(val) || val < 0 || val > 65535)
          throw new Error("Score must be 0..65535 (uint16)");

        note("Encrypting…");
        const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, await signer.getAddress());
        buf.add16(val);
        const { handles, inputProof } = await buf.encrypt();

        note("Submitting…");
        const tx = await contract.submitModuleScore(mid, handles[0], inputProof);
        note("Tx: " + tx.hash.slice(0,10) + "…");
        await tx.wait();
        note("Submitted ✓");
        await refresh();
      }catch(e){
        console.error(e);
        note(e?.reason || e?.shortMessage || e?.message || "Submit failed");
      }
    }

    async function setThresholds(){
      try{
        if (!relayer || !contract || !signer) throw new Error("Connect first");
        const isOwner = owner && me && owner.toLowerCase() === me.toLowerCase();
        if (!isOwner) throw new Error("Owner only");

        const mid = Number($("#modId").value || "1");
        const a = Number($("#t1").value || "0");
        const b = Number($("#t2").value || "0");
        const c = Number($("#t3").value || "0");
        if (![a,b,c].every(x=>Number.isInteger(x) && x>=0 && x<=65535))
          throw new Error("T1..T3 must be 0..65535 (uint16)");

        note("Encrypting thresholds…");
        const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, await signer.getAddress());
        buf.add16(a); buf.add16(b); buf.add16(c);
        const { handles, inputProof } = await buf.encrypt();

        const tx = await contract.setModuleThresholds(mid, handles[0], handles[1], handles[2], inputProof);
        note("Policy tx: " + tx.hash.slice(0,10) + "…");
        await tx.wait();
        note("Thresholds updated ✓");
      }catch(e){
        console.error(e);
        note(e?.message || "Update failed");
      }
    }

    async function userPriv(){
      try{
        if (!relayer || !signer || !contract) throw new Error("Connect first");
        const mid = Number($("#modId").value || "1");
        const r = await contract.getMyModuleHandles(mid);
        const scoreH = String(r?.[0] || "");
        if (!scoreH || /^0x0{64}$/i.test(scoreH))
          throw new Error("No score handle yet");

        const kp = await generateKeypair();
        const startTs = Math.floor(Date.now()/1000).toString();
        const daysValid = "7";

        const eip = relayer.createEIP712(
          kp.publicKey,
          [CONTRACT_ADDRESS],
          startTs,
          daysValid
        );

        const sig = await signer.signTypedData(
          eip.domain,
          { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
          eip.message
        );

        const out = await relayer.userDecrypt(
          [{ handle: scoreH, contractAddress: CONTRACT_ADDRESS }],
          kp.privateKey,
          kp.publicKey,
          String(sig).replace(/^0x/, ""),
          [CONTRACT_ADDRESS],
          await signer.getAddress(),
          startTs,
          daysValid
        );

        const v = out[scoreH] ?? out[String(scoreH).toLowerCase()];
        note("Your (private) score: " + v);
      }catch(e){
        console.error(e);
        note(e?.message || "userDecrypt failed (requires HTTPS)");
      }
    }

    connectBtn.addEventListener("click", ()=>{ if (me) location.reload(); else connect(); });
    submitBtn.addEventListener("click", submit);
    reloadBtn.addEventListener("click", refresh);
    setThrBtn.addEventListener("click", setThresholds);
    privBtn.addEventListener("click", userPriv);

    if (window.ethereum) {
      window.ethereum.on?.("accountsChanged", ()=>location.reload());
      window.ethereum.on?.("chainChanged", ()=>location.reload());
    }
  </script>
</body>
</html>
