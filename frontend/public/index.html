<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secret Darts • Zama FHEVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Required for Relayer SDK (WASM/Workers) -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />

  <style>
    :root {
      --bg-page: #f3f4f8;
      --bg-grid: radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.18), transparent 55%),
                 radial-gradient(circle at 100% 100%, rgba(191, 219, 254, 0.45), transparent 55%);
      --bg-card: #ffffff;
      --bg-card-soft: #f9fafb;
      --ink: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --border-strong: #cbd5f5;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --accent-strong: #1d4ed8;
      --success: #16a34a;
      --danger: #dc2626;
      --ring-bull: #eab308;
      --ring-inner: #22c55e;
      --ring-outer: #3b82f6;
      --ring-miss: #9ca3af;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 50px rgba(15, 23, 42, 0.14);
      --shadow-light: 0 10px 22px rgba(15, 23, 42, 0.08);
      --sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.5;
      color: var(--ink);
      background:
        var(--bg-grid),
        linear-gradient(to bottom, #f1f5f9, #e5e7eb);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* HEADER */

    .topbar {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 16px;
      padding: 10px 14px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      box-shadow: var(--shadow-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: sticky;
      top: 10px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #111827;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      background: #f9fafb;
      padding: 4px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }

    .chip-label {
      color: var(--muted);
    }

    .chip-value {
      font-family: var(--mono);
      color: #111827;
    }

    .chip-value.muted {
      color: #9ca3af;
    }

    .btn-main {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #f9fafb;
      padding: 7px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(37, 99, 235, 0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }

    .btn-main span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #bbf7d0;
      box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.45);
    }

    .btn-main:hover:not([disabled]) {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(37, 99, 235, 0.45);
      filter: brightness(1.03);
    }

    .btn-main[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
      box-shadow: none;
      filter: grayscale(0.15);
    }

    @media (max-width: 880px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .topbar-right {
        justify-content: flex-start;
      }
    }

    /* LAYOUT */

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 16px;
      margin-top: 8px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Cards */

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 0 0, rgba(191, 219, 254, 0.35), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(219, 234, 254, 0.5), transparent 60%);
      opacity: 0.45;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #111827;
    }

    .card-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: var(--bg-card-soft);
      padding: 3px 8px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      white-space: nowrap;
    }

    .pill.good {
      border-color: rgba(22, 163, 74, 0.7);
      color: #166534;
      background: #dcfce7;
    }

    .pill.warn {
      border-color: rgba(234, 179, 8, 0.8);
      color: #854d0e;
      background: #fef9c3;
    }

    .pill.bad {
      border-color: rgba(220, 38, 38, 0.8);
      color: #991b1b;
      background: #fee2e2;
    }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    /* Board column (RIGHT) */

    .board-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dart-board-container {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dart-board {
      position: relative;
      width: min(320px, 68vw);
      aspect-ratio: 1 / 1;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 50%, #f9fafb 0, #e5e7eb 45%, #d1d5db 63%, #9ca3af 100%);
      border: 1px solid rgba(156, 163, 175, 0.9);
      box-shadow:
        0 18px 30px rgba(15, 23, 42, 0.18),
        0 0 0 1px rgba(148, 163, 184, 0.7);
      cursor: crosshair;
      overflow: hidden;
    }

    .dart-ring {
      position: absolute;
      inset: 18%;
      border-radius: 999px;
      border: 2px solid rgba(129, 140, 248, 0.6);
    }

    .dart-ring.inner {
      inset: 34%;
      border-color: rgba(34, 197, 94, 0.8);
    }

    .dart-ring.bull {
      inset: 48%;
      border-color: rgba(234, 179, 8, 0.9);
      background: radial-gradient(circle, #facc15 0, #fde047 40%, transparent 70%);
    }

    .dart-axis {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148, 163, 184, 0.7), transparent);
      transform-origin: center;
      pointer-events: none;
    }

    .dart-axis.y {
      transform: translate(-50%, -50%) rotate(90deg);
    }

    .dart-axis.x {
      transform: translate(-50%, -50%);
    }

    .dart-click-marker {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #22c55e;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
      transform: translate(-50%, -50%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.12s ease;
    }

    .dart-click-marker.visible {
      opacity: 1;
    }

    .board-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .coords-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .badge {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: var(--bg-card-soft);
      padding: 2px 7px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--ring-miss);
    }

    .badge-dot.outer {
      background: var(--ring-outer);
    }

    .badge-dot.inner {
      background: var(--ring-inner);
    }

    .badge-dot.bull {
      background: var(--ring-bull);
    }

    .badge-dot.miss {
      background: var(--ring-miss);
    }

    /* Buttons + status */

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: var(--bg-card-soft);
      color: var(--ink);
      font-size: 11px;
      padding: 6px 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.1s ease, transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
    }

    .btn:hover:not([disabled]) {
      background: #e5edff;
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(148, 163, 184, 0.7);
      border-color: var(--accent-soft);
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-accent {
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      border-color: rgba(59, 130, 246, 0.9);
      color: #eff6ff;
      font-weight: 600;
    }

    .btn-accent:hover:not([disabled]) {
      filter: brightness(1.05);
    }

    .btn-ghost {
      background: transparent;
      border-style: dashed;
      border-color: var(--border-strong);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 10px;
    }

    .status-line {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-line strong {
      color: var(--ink);
    }

    /* Result cards */

    .result-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 10px;
    }

    @media (max-width: 720px) {
      .result-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .result-card {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg-card-soft);
      padding: 9px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .result-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .result-main {
      font-size: 18px;
      font-weight: 700;
    }

    .result-main.miss {
      color: var(--ring-miss);
    }

    .result-main.outer {
      color: var(--ring-outer);
    }

    .result-main.inner {
      color: var(--ring-inner);
    }

    .result-main.bull {
      color: var(--ring-bull);
    }

    .result-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .handle-text {
      font-family: var(--mono);
      font-size: 10px;
      color: #6b7280;
      word-break: break-all;
    }

    .https-note {
      font-size: 10px;
      color: var(--muted);
    }

    .https-note strong {
      color: var(--ink);
    }

    /* Admin */

    .admin-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 720px) {
      .admin-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
    }

    .field-label {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      color: var(--muted);
    }

    .field-label span.title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #111827;
      font-size: 10px;
    }

    .field-label small {
      font-size: 10px;
    }

    .input-shell {
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: #f9fafb;
      padding: 5px 9px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-shell input {
      border: none;
      outline: none;
      background: transparent;
      color: #111827;
      font-family: var(--sans);
      font-size: 12px;
      width: 100%;
    }

    .input-shell input::placeholder {
      color: #9ca3af;
    }

    .input-suffix {
      font-size: 10px;
      color: var(--muted);
      white-space: nowrap;
    }

    .field-note {
      font-size: 10px;
      color: var(--muted);
    }

    .mono {
      font-family: var(--mono);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="topbar">
      <div class="brand">
        <div class="brand-title">Secret Darts</div>
        <div class="brand-sub">Click the target, encrypt (x, y), and let Zama FHEVM classify your hit.</div>
      </div>
      <div class="topbar-right">
        <div class="chip-row">
          <div class="chip">
            <span class="chip-label">Network</span>
            <span id="netLabel" class="chip-value muted">—</span>
          </div>
          <div class="chip">
            <span class="chip-label">You</span>
            <span id="accountLabel" class="chip-value muted">not connected</span>
          </div>
          <div class="chip">
            <span class="chip-label">Contract</span>
            <span id="contractLabel" class="chip-value mono">—</span>
          </div>
        </div>
        <button id="connectBtn" class="btn-main">
          <span class="dot"></span>
          <span id="connectBtnLabel">Connect wallet</span>
        </button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT COLUMN: RESULT + ADMIN -->
      <section class="card">
        <div class="card-inner">
          <!-- Result card -->
          <div class="card-header">
            <div>
              <div class="card-title">2. Decrypt your ring</div>
              <div class="card-sub">
                The contract stores only encrypted coordinates and ring code. Decrypt the last shot locally via the Relayer.
              </div>
            </div>
            <span id="decryptTag" class="pill warn">decrypt</span>
          </div>

          <div class="status-line">
            <span>After throwing a dart, use <strong>Decrypt last shot</strong> to reveal where it landed.</span>
            <button id="decryptBtn" class="btn btn-sm btn-ghost">Decrypt last shot</button>
          </div>

          <div class="result-grid">
            <div class="result-card">
              <div class="result-title">Ring outcome</div>
              <div id="ringMain" class="result-main miss">—</div>
              <div id="ringSub" class="result-sub">
                No shot recorded yet.
              </div>
            </div>
            <div class="result-card">
              <div class="result-title">Distance & HTTPS</div>
              <div id="distMain" class="result-main" style="font-size:16px;">—</div>
              <div id="distSub" class="result-sub">Squared distance to center in encrypted space.</div>
              <div id="httpsNote" class="https-note" style="margin-top:4px;">
                Decryption runs best over <strong>HTTPS</strong> or a secure localhost origin.
              </div>
            </div>
          </div>

          <div class="result-card">
            <div class="result-title">Last encrypted handles</div>
            <div class="result-sub">These are ciphertext handles only; clear values stay inside your browser.</div>
            <div id="handlesCoords" class="handle-text" style="margin-top:4px;">
              x: —<br />y: —
            </div>
            <div id="handlesDistRing" class="handle-text" style="margin-top:4px;">
              dist²: —<br />ring: —
            </div>
          </div>

          <!-- Admin -->
          <div class="card-header" style="margin-top:6px;">
            <div>
              <div class="card-title">3. Admin · Board radii</div>
              <div class="card-sub">
                Owner-only: configure squared distance thresholds for outer / inner / bull rings.
              </div>
            </div>
            <span id="adminRoleTag" class="pill">role: unknown</span>
          </div>

          <div class="admin-grid">
            <div class="field">
              <label class="field-label">
                <span class="title">Outer radius²</span>
                <small>uint16</small>
              </label>
              <div class="input-shell">
                <input id="outerInput" type="number" min="1" max="65535" placeholder="e.g. 3200" />
                <span class="input-suffix">dist²</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label">
                <span class="title">Inner radius²</span>
                <small>uint16</small>
              </label>
              <div class="input-shell">
                <input id="innerInput" type="number" min="1" max="65535" placeholder="e.g. 1200" />
                <span class="input-suffix">dist²</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label">
                <span class="title">Bull radius²</span>
                <small>uint16</small>
              </label>
              <div class="input-shell">
                <input id="bullInput" type="number" min="1" max="65535" placeholder="e.g. 200" />
                <span class="input-suffix">dist²</span>
              </div>
            </div>
          </div>

          <div class="status-line" style="margin-top:4px;">
            <button id="refreshBoardBtn" class="btn btn-sm btn-ghost">Refresh from contract</button>
            <button id="updateBoardBtn" class="btn btn-sm btn-ghost">Update board config</button>
          </div>
          <div id="adminStatus" class="status-line"></div>
        </div>
      </section>

      <!-- RIGHT COLUMN: BOARD + THROW -->
      <section class="card">
        <div class="card-inner board-wrapper">
          <div class="card-header">
            <div>
              <div class="card-title">1. Throw an encrypted dart</div>
              <div class="card-sub">
                Click anywhere on the target to choose coordinates. Only the encrypted (x, y) are sent to the FHEVM contract.
              </div>
            </div>
            <span id="boardStateTag" class="pill">board: n/a</span>
          </div>

          <div class="dart-board-container">
            <div id="dartBoard" class="dart-board">
              <div class="dart-axis x"></div>
              <div class="dart-axis y"></div>
              <div class="dart-ring outer"></div>
              <div class="dart-ring inner"></div>
              <div class="dart-ring bull"></div>
              <div id="dartMarker" class="dart-click-marker"></div>
            </div>
          </div>

          <div class="board-meta">
            <div class="section-label">Local selection</div>
            <div class="coords-row">
              <div class="badge">
                <span>Coordinates:</span>
                <span id="coordDisplay" class="mono">(none)</span>
              </div>
            </div>
            <div class="coords-row" style="margin-top:2px;">
              <div class="badge">
                <span class="badge-dot outer"></span>
                <span>Outer ring</span>
              </div>
              <div class="badge">
                <span class="badge-dot inner"></span>
                <span>Inner ring</span>
              </div>
              <div class="badge">
                <span class="badge-dot bull"></span>
                <span>Bull</span>
              </div>
              <div class="badge">
                <span class="badge-dot miss"></span>
                <span>Miss</span>
              </div>
            </div>
            <button id="throwBtn" class="btn btn-accent" style="margin-top:6px;">
              Throw encrypted dart
            </button>
            <div id="throwStatus" class="status-line"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Ethers + Relayer SDK -->
  <script type="module">
    import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
    import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    await initSDK();

    /* ---------- CONFIG ---------- */
    const CONTRACT_ADDRESS = "0xc7808D5dA3745632A818CEf9bD8B76CD081845c4";
    const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia

    const ORIGIN = window.location.origin;
    const HAS_LOCAL_PROXY =
      ORIGIN.includes("localhost:3443") || ORIGIN.includes("127.0.0.1:3443");
    const RELAYER_URL = HAS_LOCAL_PROXY ? `${ORIGIN}/relayer` : "https://relayer.testnet.zama.org";
    const GATEWAY_URL = HAS_LOCAL_PROXY ? `${ORIGIN}/gateway` : "https://gateway.testnet.zama.org";

    const IS_HTTPS = location.protocol === "https:" || location.hostname === "localhost" || location.hostname === "127.0.0.1";

    // ABI for SecretDarts
    const ABI = [
      { type: "function", name: "owner", stateMutability: "view", inputs: [], outputs: [{ type: "address" }] },
      { type: "function", name: "transferOwnership", stateMutability: "nonpayable", inputs: [{ name: "newOwner", type: "address" }], outputs: [] },

      {
        type: "function",
        name: "setBoardConfig",
        stateMutability: "nonpayable",
        inputs: [
          { name: "_bullRadius2", type: "uint16" },
          { name: "_innerRadius2", type: "uint16" },
          { name: "_outerRadius2", type: "uint16" }
        ],
        outputs: []
      },
      {
        type: "function",
        name: "bullRadius2",
        stateMutability: "view",
        inputs: [],
        outputs: [{ type: "uint16" }]
      },
      {
        type: "function",
        name: "innerRadius2",
        stateMutability: "view",
        inputs: [],
        outputs: [{ type: "uint16" }]
      },
      {
        type: "function",
        name: "outerRadius2",
        stateMutability: "view",
        inputs: [],
        outputs: [{ type: "uint16" }]
      },
      {
        type: "function",
        name: "boardConfigured",
        stateMutability: "view",
        inputs: [],
        outputs: [{ type: "bool" }]
      },
      {
        type: "function",
        name: "throwDart",
        stateMutability: "nonpayable",
        inputs: [
          { name: "encX", type: "bytes32" },
          { name: "encY", type: "bytes32" },
          { name: "proof", type: "bytes" }
        ],
        outputs: []
      },
      {
        type: "function",
        name: "getMyLastShotHandles",
        stateMutability: "view",
        inputs: [],
        outputs: [
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bytes32" },
          { type: "bool" }
        ]
      },
      {
        type: "function",
        name: "getPlayerRingHandle",
        stateMutability: "view",
        inputs: [{ name: "player", type: "address" }],
        outputs: [
          { type: "bytes32" },
          { type: "bool" }
        ]
      }
    ];

    /* ---------- DOM ---------- */
    const $ = (id) => document.getElementById(id);

    const netLabelEl = $("netLabel");
    const accountLabelEl = $("accountLabel");
    const contractLabelEl = $("contractLabel");

    const connectBtn = $("connectBtn");
    const connectBtnLabelEl = $("connectBtnLabel");

    const dartBoardEl = $("dartBoard");
    const dartMarkerEl = $("dartMarker");
    const coordDisplayEl = $("coordDisplay");
    const throwBtn = $("throwBtn");
    const throwStatusEl = $("throwStatus");

    const decryptBtn = $("decryptBtn");
    const decryptTagEl = $("decryptTag");
    const ringMainEl = $("ringMain");
    const ringSubEl = $("ringSub");
    const distMainEl = $("distMain");
    const distSubEl = $("distSub");
    const httpsNoteEl = $("httpsNote");
    const handlesCoordsEl = $("handlesCoords");
    const handlesDistRingEl = $("handlesDistRing");
    const boardStateTagEl = $("boardStateTag");

    const adminRoleTagEl = $("adminRoleTag");
    const outerInputEl = $("outerInput");
    const innerInputEl = $("innerInput");
    const bullInputEl = $("bullInput");
    const refreshBoardBtn = $("refreshBoardBtn");
    const updateBoardBtn = $("updateBoardBtn");
    const adminStatusEl = $("adminStatus");

    contractLabelEl.textContent = shortAddress(CONTRACT_ADDRESS);

    /* ---------- STATE ---------- */
    const state = {
      provider: null,
      signer: null,
      contract: null,
      relayer: null,
      account: null,
      owner: null,
      lastClick: null // { xUnits, yUnits }
    };

    /* ---------- HELPERS: LOGGING + BIGINT ---------- */
    const safeStringify = (obj) =>
      JSON.stringify(obj, (k, v) => (typeof v === "bigint" ? v.toString() + "n" : v), 2);

    function appendLog(...parts) {
      const msg = parts
        .map((x) =>
          typeof x === "string"
            ? x
            : (() => {
                try {
                  return safeStringify(x);
                } catch {
                  return String(x);
                }
              })()
        )
        .join(" ");
      console.log("[secret-darts]", msg);
    }

    function normalizeDecryptedValue(v) {
      if (v == null) return null;
      if (typeof v === "boolean") return v ? 1n : 0n;
      if (typeof v === "bigint" || typeof v === "number") return BigInt(v);
      if (typeof v === "string") return BigInt(v);
      return BigInt(v.toString());
    }

    function shortAddress(addr) {
      if (!addr) return "—";
      return addr.slice(0, 6) + "…" + addr.slice(-4);
    }

    function normalizeChainId(id) {
      if (!id) return "";
      const s = String(id);
      if (/^\d+$/.test(s)) {
        return "0x" + BigInt(s).toString(16);
      }
      return s.toLowerCase();
    }

    async function ensureSepolia() {
      if (!window.ethereum?.request) return false;
      let cur = normalizeChainId(
        await window.ethereum.request({ method: "eth_chainId" }).catch(() => null)
      );
      netLabelEl.textContent = cur || "unknown";
      if (cur === CHAIN_ID_HEX) return true;

      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: CHAIN_ID_HEX }]
        });
      } catch (e) {
        if (e && e.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [
              {
                chainId: CHAIN_ID_HEX,
                chainName: "Sepolia",
                nativeCurrency: { name: "Sepolia ETH", symbol: "SEP", decimals: 18 },
                rpcUrls: ["https://rpc.sepolia.org"],
                blockExplorerUrls: ["https://sepolia.etherscan.io"]
              }
            ]
          });
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: CHAIN_ID_HEX }]
          });
        } else {
          throw e;
        }
      }

      const after = normalizeChainId(
        await window.ethereum.request({ method: "eth_chainId" }).catch(() => null)
      );
      netLabelEl.textContent = after || "unknown";
      return after === CHAIN_ID_HEX;
    }

    // Build value picker from userDecrypt output
    function buildValuePicker(out, pairs) {
      let map = {};
      if (out && typeof out === "object") {
        if (Array.isArray(out.clearValues) && pairs && pairs.length) {
          pairs.forEach((p, i) => {
            const h = String(p.handle || p).toLowerCase();
            map[h] = out.clearValues[i];
          });
        }

        if (!Object.keys(map).length && typeof out.abiEncodedClearValues === "string" && pairs && pairs.length) {
          const raw = out.abiEncodedClearValues.startsWith("0x")
            ? out.abiEncodedClearValues.slice(2)
            : out.abiEncodedClearValues;
          const vals = [];
          for (let i = 0; i + 64 <= raw.length; i += 64) {
            const chunk = "0x" + raw.slice(i, i + 64);
            try {
              vals.push(BigInt(chunk));
            } catch {
              vals.push(0n);
            }
          }
          pairs.forEach((p, i) => {
            const h = String(p.handle || p).toLowerCase();
            map[h] = vals[i] ?? 0n;
          });
        }

        if (!Object.keys(map).length) {
          for (const [k, v] of Object.entries(out)) {
            map[k.toLowerCase()] = v;
          }
        }
      }

      return (handle) => {
        if (!handle) return null;
        const k = String(handle).toLowerCase();
        const v = map[k];
        if (v === undefined) return null;
        return normalizeDecryptedValue(v);
      };
    }

    async function userDecryptMany(relayer, signer, pairs) {
      const kp = await generateKeypair();
      const startTs = Math.floor(Date.now() / 1000).toString();
      const daysValid = "7";

      const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, daysValid);
      const sig = await signer.signTypedData(
        eip.domain,
        { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
        eip.message
      );

      const userAddr = await signer.getAddress();
      const out = await relayer.userDecrypt(
        pairs,
        kp.privateKey,
        kp.publicKey,
        sig.replace(/^0x/, ""),
        [CONTRACT_ADDRESS],
        userAddr,
        startTs,
        daysValid
      );
      appendLog("userDecrypt result:", out);
      return { out, pairs };
    }

    function updateHttpsUi() {
      if (IS_HTTPS) {
        decryptTagEl.textContent = "decrypt:✓";
        decryptTagEl.classList.remove("warn", "bad");
        decryptTagEl.classList.add("good");
        httpsNoteEl.innerHTML =
          'Decryptions are running in a <strong>secure context</strong>.';
      } else {
        decryptTagEl.textContent = "decrypt";
        decryptTagEl.classList.remove("good");
        decryptTagEl.classList.add("warn");
        httpsNoteEl.innerHTML =
          'Running on a non-HTTPS origin. <strong>userDecrypt</strong> may be limited by browser security.';
      }
    }

    function encodeCoordForUint16(n) {
      // Map from signed [-32768, 32767] to uint16; here n is small (e.g. [-180, 180])
      const asInt = Math.trunc(n);
      const encoded = (asInt + 65536) % 65536;
      return encoded;
    }

    function decodeCoordFromUint16(v) {
      const num = Number(v);
      return num > 32767 ? num - 65536 : num;
    }

    function setBoardStateTag(configured, radii) {
      if (!configured) {
        boardStateTagEl.textContent = "board: not configured";
        boardStateTagEl.classList.remove("good");
        boardStateTagEl.classList.add("warn");
        return;
      }
      const outer = radii.outer;
      const inner = radii.inner;
      const bull = radii.bull;
      boardStateTagEl.textContent = `board: bull ${bull}, inner ${inner}, outer ${outer}`;
      boardStateTagEl.classList.remove("warn");
      boardStateTagEl.classList.add("good");
    }

    function setRingUi(ringNum) {
      const classes = ["miss", "outer", "inner", "bull"];
      ringMainEl.classList.remove("miss", "outer", "inner", "bull");

      let label = "—";
      let desc = "No shot recorded yet.";
      let cls = "miss";

      if (ringNum === 0) {
        label = "Miss";
        desc = "Your encrypted distance landed outside the scoring rings.";
        cls = "miss";
      } else if (ringNum === 1) {
        label = "Outer ring";
        desc = "You hit the outer scoring ring under FHE.";
        cls = "outer";
      } else if (ringNum === 2) {
        label = "Inner ring";
        desc = "Clean inner ring hit – closer to the center.";
        cls = "inner";
      } else if (ringNum === 3) {
        label = "Bull";
        desc = "Bullseye! You nailed the center in encrypted space.";
        cls = "bull";
      }

      ringMainEl.textContent = label;
      ringMainEl.classList.add(cls);
      ringSubEl.textContent = desc;
    }

    /* ---------- CONNECTION ---------- */
    connectBtn.addEventListener("click", async () => {
      if (state.signer) {
        await disconnectWallet();
      } else {
        await connectWallet();
      }
    });

    async function connectWallet() {
      try {
        if (!window.ethereum?.request) {
          alert("Please install MetaMask or another EIP-1193 wallet.");
          return;
        }

        await ensureSepolia();

        const provider = new BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        const signer = await provider.getSigner();
        const account = await signer.getAddress();
        const contract = new Contract(CONTRACT_ADDRESS, ABI, signer);

        appendLog("Creating Relayer instance…");
        const relayer = await createInstance({
          ...SepoliaConfig,
          relayerUrl: RELAYER_URL,
          gatewayUrl: GATEWAY_URL,
          network: window.ethereum,
          debug: true
        });

        state.provider = provider;
        state.signer = signer;
        state.contract = contract;
        state.relayer = relayer;
        state.account = account;

        connectBtnLabelEl.textContent = "Disconnect";
        accountLabelEl.textContent = shortAddress(account);
        accountLabelEl.classList.remove("muted");
        netLabelEl.textContent = CHAIN_ID_HEX;

        appendLog("Relayer ready:", { relayerUrl: RELAYER_URL, gatewayUrl: GATEWAY_URL });

        // Detect owner
        try {
          const owner = await contract.owner();
          state.owner = owner;
          if (owner.toLowerCase() === account.toLowerCase()) {
            adminRoleTagEl.textContent = "role: owner";
            adminRoleTagEl.classList.add("good");
          } else {
            adminRoleTagEl.textContent = "role: viewer";
          }
        } catch (e) {
          appendLog("owner() read failed:", e?.message || e);
          adminRoleTagEl.textContent = "role: unknown";
        }

        updateHttpsUi();
        await refreshBoardConfig();
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        appendLog("Connect failed:", msg);
        alert(msg);
      }
    }

    async function disconnectWallet() {
      state.provider = null;
      state.signer = null;
      state.contract = null;
      state.relayer = null;
      state.account = null;
      state.owner = null;

      connectBtnLabelEl.textContent = "Connect wallet";
      accountLabelEl.textContent = "not connected";
      accountLabelEl.classList.add("muted");
      adminRoleTagEl.textContent = "role: unknown";
      adminStatusEl.textContent = "";
      throwStatusEl.textContent = "";

      ringMainEl.textContent = "—";
      ringMainEl.classList.remove("miss", "outer", "inner", "bull");
      ringMainEl.classList.add("miss");
      ringSubEl.textContent = "No shot recorded yet.";
      distMainEl.textContent = "—";
      distSubEl.textContent = "Squared distance to center in encrypted space.";
      handlesCoordsEl.textContent = "x: —\ny: —";
      handlesDistRingEl.textContent = "dist²: —\nring: —";
      setBoardStateTag(false, { outer: 0, inner: 0, bull: 0 });

      appendLog("Disconnected");
    }

    /* ---------- BOARD CONFIG (ADMIN) ---------- */
    refreshBoardBtn.addEventListener("click", () => {
      refreshBoardConfig();
    });

    updateBoardBtn.addEventListener("click", async () => {
      try {
        if (!state.contract || !state.signer || !state.relayer || !state.account) {
          throw new Error("Connect wallet first.");
        }
        if (!state.owner || state.owner.toLowerCase() !== state.account.toLowerCase()) {
          throw new Error("Only contract owner can update board config.");
        }

        const outer = Number(outerInputEl.value || "0");
        const inner = Number(innerInputEl.value || "0");
        const bull = Number(bullInputEl.value || "0");

        for (const [name, v] of [
          ["Outer radius²", outer],
          ["Inner radius²", inner],
          ["Bull radius²", bull]
        ]) {
          if (!Number.isInteger(v) || v <= 0 || v > 65535) {
            throw new Error(`${name} must be an integer between 1 and 65535.`);
          }
        }

        if (!(bull < inner && inner < outer)) {
          throw new Error("Expected: bullRadius² < innerRadius² < outerRadius².");
        }

        adminStatusEl.textContent = "Updating board config...";
        const tx = await state.contract.setBoardConfig(
          BigInt(bull),
          BigInt(inner),
          BigInt(outer)
        );

        adminStatusEl.textContent = "Tx sent: " + tx.hash.slice(0, 10) + "…";
        appendLog("setBoardConfig tx:", tx.hash);

        await tx.wait();
        adminStatusEl.textContent = "Board config updated ✓";

        await refreshBoardConfig();
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        adminStatusEl.textContent = msg;
        appendLog("setBoardConfig error:", msg);
        alert(msg);
      }
    });

    async function refreshBoardConfig() {
      try {
        if (!state.contract) {
          setBoardStateTag(false, { outer: 0, inner: 0, bull: 0 });
          return;
        }
        const configured = await state.contract.boardConfigured();
        if (!configured) {
          setBoardStateTag(false, { outer: 0, inner: 0, bull: 0 });
          return;
        }

        const outer = await state.contract.outerRadius2();
        const inner = await state.contract.innerRadius2();
        const bull = await state.contract.bullRadius2();

        const outerNum = Number(outer);
        const innerNum = Number(inner);
        const bullNum = Number(bull);

        outerInputEl.value = String(outerNum);
        innerInputEl.value = String(innerNum);
        bullInputEl.value = String(bullNum);

        setBoardStateTag(true, { outer: outerNum, inner: innerNum, bull: bullNum });
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        appendLog("refreshBoardConfig error:", msg);
        setBoardStateTag(false, { outer: 0, inner: 0, bull: 0 });
      }
    }

    /* ---------- BOARD INTERACTION ---------- */
    dartBoardEl.addEventListener("click", (ev) => {
      const rect = dartBoardEl.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      const px = ev.clientX - cx;
      const py = cy - ev.clientY; // invert y for math

      const radiusPx = rect.width / 2;
      const scale = 180 / radiusPx; // map to approx [-180, 180]

      const xUnits = Math.round(px * scale);
      const yUnits = Math.round(py * scale);

      state.lastClick = { xUnits, yUnits };

      coordDisplayEl.textContent = `(${xUnits}, ${yUnits})`;

      // Move marker
      const relX = (px / radiusPx) * 50; // %
      const relY = (-py / radiusPx) * 50;
      dartMarkerEl.style.left = `${50 + relX}%`;
      dartMarkerEl.style.top = `${50 + relY}%`;
      dartMarkerEl.classList.add("visible");

      throwStatusEl.textContent = "Coordinates selected. Ready to encrypt and throw.";
    });

    /* ---------- THROW ENCRYPTED DART ---------- */
    throwBtn.addEventListener("click", async () => {
      try {
        if (!state.contract || !state.relayer || !state.signer || !state.account) {
          throw new Error("Connect wallet first.");
        }
        if (!state.lastClick) {
          throw new Error("Click on the board to choose coordinates first.");
        }

        const configured = await state.contract.boardConfigured();
        if (!configured) {
          throw new Error("Board not configured on-chain yet.");
        }

        const { xUnits, yUnits } = state.lastClick;
        const encX = encodeCoordForUint16(xUnits);
        const encY = encodeCoordForUint16(yUnits);

        throwStatusEl.textContent = "Encrypting (x, y)…";

        const buf = state.relayer.createEncryptedInput(CONTRACT_ADDRESS, state.account);
        buf.add16(encX);
        buf.add16(encY);

        const { handles, inputProof } = await buf.encrypt();
        appendLog("throwDart handles:", handles);

        const tx = await state.contract.throwDart(
          handles[0],
          handles[1],
          inputProof
        );

        throwStatusEl.textContent = "Transaction sent: " + tx.hash.slice(0, 10) + "…";
        appendLog("throwDart tx:", tx.hash);

        await tx.wait();
        throwStatusEl.textContent = "Encrypted dart recorded ✓";

        // Clear last visible result until user decrypts again
        ringMainEl.textContent = "—";
        ringMainEl.classList.remove("miss", "outer", "inner", "bull");
        ringMainEl.classList.add("miss");
        ringSubEl.textContent = "Decrypt to see where you landed.";

        distMainEl.textContent = "—";
        distSubEl.textContent = "Squared distance to center in encrypted space.";

        handlesCoordsEl.textContent = "x: —\ny: —";
        handlesDistRingEl.textContent = "dist²: —\nring: —";
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        throwStatusEl.textContent = msg;
        appendLog("throwDart error:", msg);
        alert(msg);
      }
    });

    /* ---------- DECRYPT LAST SHOT ---------- */
    decryptBtn.addEventListener("click", async () => {
      try {
        if (!state.contract || !state.relayer || !state.signer || !state.account) {
          throw new Error("Connect wallet first.");
        }
        if (!IS_HTTPS) {
          appendLog("userDecrypt on non-HTTPS origin (may be restricted).");
        }

        const r = await state.contract.getMyLastShotHandles();
        const xH = r?.[0];
        const yH = r?.[1];
        const dist2H = r?.[2];
        const ringH = r?.[3];
        const decided = !!r?.[4];

        if (!decided || !xH || !yH || !ringH) {
          setRingUi(0);
          distMainEl.textContent = "—";
          distSubEl.textContent = "No shot recorded yet.";
          handlesCoordsEl.textContent = "x: —\ny: —";
          handlesDistRingEl.textContent = "dist²: —\nring: —";
          return;
        }

        handlesCoordsEl.textContent = `x: ${String(xH)}\ny: ${String(yH)}`;
        handlesDistRingEl.textContent = `dist²: ${String(dist2H)}\nring: ${String(ringH)}`;

        const pairs = [
          { handle: xH, contractAddress: CONTRACT_ADDRESS },
          { handle: yH, contractAddress: CONTRACT_ADDRESS },
          { handle: dist2H, contractAddress: CONTRACT_ADDRESS },
          { handle: ringH, contractAddress: CONTRACT_ADDRESS }
        ];

        const { out, pairs: used } = await userDecryptMany(state.relayer, state.signer, pairs);
        const pick = buildValuePicker(out, used);

        const xVal = pick(xH);
        const yVal = pick(yH);
        const distVal = pick(dist2H);
        const ringVal = pick(ringH);

        const ringBig = ringVal != null ? ringVal : 0n;
        const ringNum = Number(ringBig);

        setRingUi(ringNum);

        if (distVal != null) {
          const dNum = Number(distVal);
          distMainEl.textContent = `d² = ${dNum}`;
          const approx = Math.sqrt(dNum);
          const approxClean = Math.round(approx * 10) / 10;
          distSubEl.textContent = `Approximate distance from center: ~${approxClean} units.`;
        } else {
          distMainEl.textContent = "n/a";
          distSubEl.textContent = "Could not decrypt squared distance.";
        }

        if (xVal != null && yVal != null) {
          const dx = decodeCoordFromUint16(xVal);
          const dy = decodeCoordFromUint16(yVal);
          coordDisplayEl.textContent = `(${dx}, ${dy})`;
        }
      } catch (e) {
        const msg = e?.reason || e?.shortMessage || e?.message || String(e);
        appendLog("decrypt error:", msg);
        alert(msg);
      }
    });

    /* ---------- INIT ---------- */
    updateHttpsUi();
    setBoardStateTag(false, { outer: 0, inner: 0, bull: 0 });

    // Auto-connect if already authorized
    if (window.ethereum) {
      try {
        const accounts = await window.ethereum.request({ method: "eth_accounts" });
        if (accounts && accounts.length) {
          appendLog("Wallet already authorized, auto-connecting…");
          await connectWallet();
        }
      } catch (e) {
        appendLog("Auto-connect failed:", e?.message || e);
      }

      window.ethereum.on?.("accountsChanged", () => {
        location.reload();
      });
      window.ethereum.on?.("chainChanged", () => {
        location.reload();
      });
    }
  </script>
</body>
</html>
